{% extends "wagtailadmin/base.html" %}

{% load i18n %}

{% block titletag %}Import Comments{% endblock %}
{% block extra_css %}
  {{ block.super }}
  <style></style>
{% endblock %}

{% block content %}
  {% trans "Import Comments" as title %}
  {% include "wagtailadmin/shared/header.html" with title=title icon="tasks" %}

  <div class="nice-padding">
    <p class="help-block help-warning custom-warning" hidden>{% trans "It takes a several minutes do not reload the page!" %}</p>
  </div>

  <div class="nice-padding">
		<form id="page-edit-form" action="/admin/import_comments/" method="POST" enctype="multipart/form-data" onSubmit="showWarning()">
      {% csrf_token %}
      <fieldset class="">
        <legend>Для поисковых систем</legend>
        <ul class="fields">
          <li class="required file_field">
            <div class="field file_field file_input" data-contentpath="file">
              <label for="id_file">{% trans "CSV File" %}:</label>
              <div class="field-content">
                <div class="input">
                  <input type="file" name="file" accept=".csv" required id="id_file">
                </div>
              </div>
            </div>
          </li>
        </ul>
        <button type="submit" class="button">{% trans "Import" %}</button>
      </fieldset>
    </form>

	<script>
		function showWarning() {
				document.querySelector('.custom-warning').removeAttribute('hidden');
		}

		document.addEventListener('DOMContentLoaded', () => {
			const form = document.getElementById('page-edit-form');
			const submitButton = form.querySelector('button[type="submit"]');
			const warning = document.querySelector('.custom-warning');

			form.addEventListener('submit', async (e) => {
				e.preventDefault(); // Остановим обычную отправку
				submitButton.disabled = true; // Отключим кнопку отправки

				warning.removeAttribute('hidden');
				const fileInput = document.querySelector('#id_file');
				const file = fileInput.files[0];

				if (!file) return;

				const formData = new FormData();
				formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
				formData.append('file', file);

				form.reset();

				const response = await fetch(form.action, {
					method: 'POST',
					body: formData,
				});

				if (!response.ok) {
					warning.textContent = `❌ Ошибка импорта: ${response.status}`;
					return;
				}

				const reader = response.body.getReader();
				const decoder = new TextDecoder();
				let text = '';

				const outputBox = document.createElement('pre');
				outputBox.style.padding = '1em';
				outputBox.style.border = '1px solid #ccc';
				outputBox.style.backgroundColor = '#f9f9f9';
				outputBox.style.maxHeight = '400px';
				outputBox.style.overflowY = 'auto';
				form.insertAdjacentElement('afterend', outputBox);

				while (true) {
					const { done, value } = await reader.read();
					if (done) break;
					text += decoder.decode(value, { stream: true });
					outputBox.textContent += text;
					outputBox.scrollTop = outputBox.scrollHeight;
					text = '';
				}

				warning.textContent = '✅ Импорт завершён.';
				submitButton.disabled = false; // Включим кнопку отправки
			});
		});
	</script>

    {% include "comments/admin/import_example.html" %}
  </div>
{% endblock %}
