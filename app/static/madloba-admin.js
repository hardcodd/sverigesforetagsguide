const escapeHtml=e=>{if(null==e)return"";return String(e)},truncate=(e,t=50)=>{const r=String(e??"");return r.length>t?`${r.slice(0,t)}â€¦`:r},updateProgressBar=(e,t)=>{const r=Math.max(0,Math.min(100,0|t));e.style.width=`${r}%`,e.textContent=`${r}%`},renderTable=(e,t,r)=>new Promise((s=>{const n=document.querySelector(".csv-table");if(!n)return s([]);if(n.innerHTML="",t?.classList?.add("active"),updateProgressBar(r,0),!Array.isArray(e)||0===e.length){const e=document.createElement("caption");return e.textContent="No data to import",n.appendChild(e),s([])}const o=document.createElement("thead"),a=document.createElement("tr"),c=Object.keys(e[0]??{});c.forEach((e=>{const t=document.createElement("th");t.textContent=e,a.appendChild(t)}));const l=document.createElement("th");l.textContent="Status",a.insertBefore(l,a.firstChild),o.appendChild(a),n.appendChild(o);const d=document.createElement("tbody");let i=0;for(const t of e){i+=1;const e=document.createElement("tr");e.id=`row-${i}`,c.forEach((r=>{const s=t[r],n=document.createElement("td"),o=escapeHtml(truncate(s,50));n.textContent=o,e.appendChild(n)}));const r=document.createElement("td");r.classList.add("status-message"),e.insertBefore(r,e.firstChild),d.appendChild(e)}n.appendChild(d),s(e)})),postRow=async(e,t,r)=>{const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":t},body:JSON.stringify(r)});let n={};try{n=await s.json()}catch(e){}return{ok:s.ok&&n&&!0===n.success,message:n?.message||(s.ok?"OK":`HTTP ${s.status}`)}},importSequentially=async(e,t,r,s)=>{const n=t.length;let o=0;const a=document.querySelector(".csv-table tbody");for(let a=0;a<n;a+=1){const c=t[a];c.is_first=0===a,c.is_last=a===n-1;const l=`row-${a+1}`,d=document.getElementById(l),i=d?.querySelector(".status-message");try{document.querySelector("#import-organizations-form");const t=await postRow(e,r.value,c);t.ok?(d?.classList?.remove("error"),d?.classList?.add("success"),d.querySelector(".status-message").textContent="Imported!"):(d?.classList?.remove("success"),d?.classList?.add("Already exists!"===t.message?"warning":"error"),i.textContent=t.message)}catch(e){d?.classList?.remove("success"),d?.classList?.add("error"),i.textContent=e?.message||e}finally{o+=1;const e=Math.round(o/n*100);updateProgressBar(s,e)}}const c=a.querySelectorAll("tr.success").length,l=a.querySelectorAll("tr.warning"),d=a.querySelectorAll("tr.error");l.forEach((e=>a.appendChild(e))),d.forEach((e=>a.appendChild(e))),alert(`Import completed: ${o} of ${n} rows processed. Successful: ${c}, Warnings: ${l.length}, Errors: ${d.length}.`)};document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#import-organizations-form");if(!e)return;const t=e.querySelector("input[name='csrfmiddlewaretoken']"),r=document.querySelector("#import-progress"),s=document.querySelector(".bar");e.addEventListener("submit",(n=>{n.preventDefault();const o=e.file?.files?.[0];o&&Papa.parse(o,{header:!0,skipEmptyLines:!0,encoding:"utf-8",complete:async n=>{const o=n?.data?.filter(Boolean)||[];await renderTable(o,r,s),await importSequentially(e.action,o,t,s)},error:e=>alert("Parsing error: "+e.message)})}))}));